<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causal Inference Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mermaid {
            display: flex;
            justify-content: center;
            background-color: #ffffff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            min-height: 200px;
        }
        .node rect {
            fill: #f5f3ff !important;
            stroke: #7c3aed !important;
            stroke-width: 2px !important;
        }
        .edgePath path {
            stroke: #8b5cf6 !important;
            stroke-width: 2.5px !important;
        }
        .label-container {
            font-size: 14px;
            font-weight: 600;
        }
        pre.mermaid {
            background: none !important;
            border: none !important;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
    <div class="max-w-6xl mx-auto py-12 px-6">
        <header class="mb-12 border-b border-slate-200 pb-10 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
                    Causal Inference <span class="text-violet-600">Analysis Report</span>
                </h1>
                <p class="text-lg text-slate-500 mt-2 font-medium"> Structural consistency evaluation for counterfactual reasoning. </p>
            </div>
            <div class="flex items-center gap-3 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                <label for="example-selector" class="text-sm font-bold text-slate-400 uppercase tracking-widest pl-2">Case Study:</label>
                <select id="example-selector" class="bg-slate-50 border-none text-slate-800 font-semibold py-2 px-4 rounded-lg focus:ring-2 focus:ring-violet-500 cursor-pointer">
                    <option value="sports_donk_vitality">Sports: Donk vs Vitality</option>
                    <option value="daily_delayed_train">Daily: Delayed Train</option>
                    <option value="daily_lucy_umbrealla">Daily: Lucy's Umbrella</option>
                    <option value="health_lucy_gain_weights">Health: Lucy's Weight Gain</option>
                    <option value="physics_photoelectric_effect">Physics: Photoelectric Effect</option>
                </select>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <!-- Sidebar: Diagram and Metadata (4 columns) -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Causal Graph -->
                <section class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-5 bg-violet-600">
                        <h3 class="text-lg font-bold text-white flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            Causal Diagram (G)
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="mermaid-container" class="mermaid mb-6">
                            <!-- Diagram Injected Here -->
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Structural Definition</span>
                            <div id="raw-graph-text" class="text-xs font-mono text-slate-600 break-words leading-relaxed"></div>
                        </div>
                    </div>
                </section>

                <!-- Intervention Info -->
                <section class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-5 bg-amber-500">
                        <h3 class="text-lg font-bold text-white flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Intervention Logic
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Variable of Interest (V)</span>
                            <p id="intervention-variable" class="text-slate-800 font-bold leading-tight"></p>
                        </div>
                        <div class="pt-4 border-t border-slate-100">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Formal Expression (M)</span>
                            <div id="math-query" class="font-mono text-[11px] text-violet-700 bg-violet-50 p-3 rounded-lg border border-violet-100 leading-normal"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Main Content: Stories and Evaluation (8 columns) -->
            <div class="lg:col-span-8 space-y-10">
                <!-- Factual Context -->
                <section class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-8 py-6 bg-slate-900 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18 18.247 18.477 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            Factual Narrative (T)
                        </h3>
                        <span class="bg-slate-800 text-slate-400 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest">Ground Truth</span>
                    </div>
                    <div class="p-10">
                        <p id="factual-story" class="text-xl leading-relaxed text-slate-700 italic font-medium"></p>
                    </div>
                </section>

                <!-- Counterfactual Question -->
                <section class="bg-violet-50 rounded-3xl shadow-sm border border-violet-200 overflow-hidden ring-8 ring-violet-50/50">
                    <div class="px-8 py-6 bg-violet-100/50 border-b border-violet-200">
                        <h3 class="text-lg font-bold text-violet-900 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Counterfactual Query (Q)
                        </h3>
                    </div>
                    <div class="p-10">
                        <p id="cf-question" class="text-2xl font-bold text-slate-800 leading-tight tracking-tight"></p>
                    </div>
                </section>

                <!-- Model Outputs Comparison -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-3xl shadow-sm border border-emerald-200 overflow-hidden group hover:border-emerald-400 transition-colors">
                        <div class="px-6 py-4 bg-emerald-500 text-white text-xs font-black uppercase tracking-[0.2em] flex justify-between items-center">
                            <span>Response S</span>
                            <svg class="w-4 h-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div class="p-8">
                            <p id="response-s" class="text-slate-600 leading-relaxed font-medium"></p>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-rose-200 overflow-hidden group hover:border-rose-400 transition-colors">
                        <div class="px-6 py-4 bg-rose-500 text-white text-xs font-black uppercase tracking-[0.2em] flex justify-between items-center">
                            <span>Response S'</span>
                            <svg class="w-4 h-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div class="p-8">
                            <p id="response-s-prime" class="text-slate-600 leading-relaxed font-medium"></p>
                        </div>
                    </div>
                </div>

                <!-- Failure Analysis -->
                <section class="bg-rose-50 rounded-3xl shadow-sm border-2 border-rose-200 overflow-hidden">
                    <div class="px-8 py-6 bg-rose-100/50 border-b border-rose-200 flex items-center">
                        <div class="w-10 h-10 bg-rose-500 rounded-full flex items-center justify-center mr-4 shadow-lg shadow-rose-200">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <h3 class="text-xl font-black text-rose-900 uppercase tracking-tight">Diagnostic Analysis</h3>
                    </div>
                    <div class="p-10">
                        <p id="error-description" class="text-rose-900 font-bold text-xl leading-relaxed"></p>
                    </div>
                </section>
            </div>
        </div>

        <footer class="mt-20 pt-8 border-t border-slate-200 flex justify-between items-center text-slate-400 text-xs font-bold uppercase tracking-[0.3em]">
            <span>Causal Inference Evaluation</span>
            <span>&copy; 2025 AI Research Lab</span>
        </footer>
    </div>

    <script>
        const examples = {
            "sports_donk_vitality": {
                "G": "A (practice) -> B (confidence) -> C (performance), A (practice) -> C (performance)",
                "T": "DONK practiced his aim for the Counter Strike Budapest Major grand final against Team Vitality. His teammate Shiro saw his effort and felt confident about the grand final, so he played decisively and took key fights. Donk and Shiro performed well and eventually 3:0 Team Vitality.",
                "V": "B (Shiro's confidence about the grand final)",
                "Q": "Given the above text, generate the text that would have been had Shiro felt unconfident about the grand final. Keep the same format and the same length of the story.",
                "M": "Output t' with P(T_B = b' = t' | T = t, where b' corresponds to 'Shiro felt unconfident'.)",
                "S": "DONK practiced his aim for the Counter Strike Budapest Major grand final against Team Vitality. His teammate Shiro saw his effort and felt unconfident about the grand final, so he played defensively and avoided key fights. Donk and Shiro performed poorly and eventually 0:3 Team Vitality.",
                "S'": "DONK practiced his aim for the Counter Strike Budapest Major grand final against Team Vitality. His teammate Shiro saw his effort and felt anxious about the grand final, fearing that Donk was overworking himself and that their momentum would stall against such a titan. Donk and Shiro performed well and eventually 3:0 Team Vitality.",
                "Error": "Type I: The LLM changes B (confident -> unconfident) but leaves C unchanged ('performed well' and '3:0'), missing the downstream consequence required by the causal structure encoded in the story."
            },
            "daily_delayed_train": {
                "G": "A (Snowstorm severity) -> B (Road accidents), A (Snowstorm severity) -> C (Subway delay), B (Road accidents) -> D (Arrival time), C (Subway delay) -> D (Arrival time), F (Alarm battery dies) -> D (Arrival time), D (Arrival time) -> G (Redbull to stay sharp), D (Arrival time) -> E (Client's impression), G (Coffee to stay sharp) -> E (Client's impression)",
                "T": "A snowstorm hit the city, causing several road accidents and a subway delay. Jamie’s alarm battery died, so he left home an hour late. Because of the accidents and the delayed subway, his commute ran long and he arrived late to the client presentation. He grabbed a strong coffee to stay sharp, but the client still thought he was unprepared.",
                "V": "C (Subway delay)",
                "Q": "Given the above text, generate the text that would have been had the subway not been delayed.",
                "M": "Output t' with P(T_C = c' = t' | T = t), where c' corresponds to 'the subway was not delayed (on time)'.",
                "S": "A snowstorm hit the city, causing several road accidents, but the subway was not delayed. Jamie’s alarm battery died, so he left home an hour late. Even with the subway running on time, the accidents and his late departure meant he still arrived late to the client presentation. He drank a redbull to stay sharp, but the client still thought he was unprepared.",
                "S'": "A snowstorm hit the city, causing several road accidents, but the subway was not delayed. Jamie’s alarm battery worked perfectly, so he left home right on schedule. With the subway running on time, the accidents did not affect him and his timely departure meant he arrived early to the client presentation. He didn't need a redbull to stay sharp, and the client thought he was highly prepared.",
                "Error": "Type II: The LLM changes F (Alarm battery dies) to justify the no-delay outcome, which is an incorrect counterfactual edit since alarm battery is not affected by the subway delay."
            },
            "daily_lucy_umbrealla": {
                "G": "B (Carried an umbrella?) <- A (Weather) -> C (Street wetness), B (Carried an umbrella?) -> D (Umbrella stolen?) -> E (Lucy's mood)",
                "T": "It was raining in the morning, so Lucy carried an umbrella to work. The street was wet. After Lucy arrived at work, her umbrella was stolen, so she felt depressed.",
                "V": "B (Lucy carried an umbrella)",
                "Q": "Given the above text, generate the text that would have been had Lucy not carried an umbrella.",
                "M": "Output t' with P(T_B = b' = t' | T = t), where b' corresponds to 'Lucy did not carry an umbrella'.",
                "S": "It was raining in the morning, so Lucy did not carry an umbrella to work. The street was wet. After Lucy arrived at work, her umbrella was not stolen, so she did not feel depressed about the theft.",
                "S'": "It was raining in the morning, so Lucy did not carry an umbrella to work. The street was wet. After Lucy arrived at work, her clothes were soaked, so she felt depressed.",
                "Error": "Type III (Correlation Effect): The LLM substitutes a different causal explanation (soaked clothes) to keep Lucy depressed, and it introduces a new mechanism not present in the causal diagram/story variables, rather than performing the counterfactual edit implied by the given causal structure."
            },
            "health_lucy_gain_weights": {
                "G": "A (Sleep) -> B (Metabolism), A (Sleep) -> C (Appetite), B (Metabolism) -> D (Weight gain), C (Appetite) -> D (Weight gain)",
                "T": "Lucy ate far more calories than she burned, so she gained a lot of weight. Because she felt overweight, she was very unconfident during the presentation and spoke timidly. Separately, Lucy didn’t prepare her speech well because she was busy that week, so she forgot key points and performed very badly.",
                "V": "B (Weight gain)",
                "Q": "Given the above text, generate the text that would have been had Lucy not gained a lot of weight.",
                "M": "Output t' with P(T_B = b' = t' | T = t), where b' corresponds to 'Lucy did not gain a lot of weight'.",
                "S": "Lucy ate far more calories than she burned, but she did not gain a lot of weight. Because she did not feel overweight, she was more confident during the presentation and spoke less timidly. Separately, Lucy didn’t prepare her speech well because she was busy that week, so she forgot key points and still performed poorly overall.",
                "S'": "Lucy ate exactly as many calories as she burned, so she maintained her weight. Because she felt comfortable with her appearance, she was confident during the presentation and spoke boldly. Separately, Lucy didn’t prepare her speech well because she was busy that week, so she forgot key points and performed very badly.",
                "Error": "Type II: The LLM changes the upstream variable A (Calorie surplus) by rewriting 'Lucy ate far more calories than she burned' into 'Lucy ate exactly as many calories as she burned' to justify the no-weight-gain outcome."
            },
            "physics_photoelectric_effect": {
                "G": "A (Photon wavelength) -> B (Electron flies out of aluminum), A (Photon wavelength) -> C (Observation of an electron flying out), B (Electron flies out of aluminum) -> D (CMOS dot noise), C (Observation of an electron flying out) -> D (CMOS dot noise)",
                "T": "Lucy shot a photon with an appropriate wave length on the aluminum metal, and she observed an electron flew out. At the mean time, Emma was testing a CMOS functionality, and she captured the moment when the electron flew out and landed on the CMOS, so the CMOS generate an image with a small dot noise.",
                "V": "B (Electron flies out of aluminum)",
                "Q": "Given the above text, generate the text that would have been had the electron never flew out.",
                "M": "Output t' with P(T_B = b' = t' | T = t), where b' corresponds to 'the electron never flew out'.",
                "S": "Lucy shot a photon with an appropriate wave length on the aluminum metal, yet no electron flew out. At the mean time, Emma was testing a CMOS functionality, and she captured the moment when nothing landed on the CMOS, so the CMOS generate an image without the small dot noise.",
                "S'": "Lucy shot a photon with an inadequate wavelength on the aluminum metal, and she observed that no electron flew out. At the same time, Emma was testing a CMOS functionality, and she captured the moment when nothing hit the sensor, so the CMOS generated a perfectly clean image without any dot noise.",
                "Error": "Type II: The LLM changes A by rewriting 'appropriate wavelength' into 'inadequate wavelength' to justify the no-electron outcome, which is an incorrect counterfactual edit."
            }
        };

        function parseGraphToMermaid(g) {
            let mermaidStr = 'graph TD\n';
            const paths = g.split(',').map(p => p.trim());
            
            paths.forEach(path => {
                const tokens = path.split(/\s*(->|<-)\s*/);
                for (let i = 1; i < tokens.length; i += 2) {
                    const arrow = tokens[i];
                    const left = tokens[i-1];
                    const right = tokens[i+1];
                    
                    const leftMatch = left.match(/([A-Z](?:\?|')?)\s*\((.*?)\)/);
                    const rightMatch = right.match(/([A-Z](?:\?|')?)\s*\((.*?)\)/);
                    
                    const leftId = leftMatch ? leftMatch[1].replace(/[^A-Za-z0-9]/g, '_') : left.replace(/[^A-Za-z0-9]/g, '_');
                    const leftLabel = leftMatch ? leftMatch[2] : left;
                    const rightId = rightMatch ? rightMatch[1].replace(/[^A-Za-z0-9]/g, '_') : right.replace(/[^A-Za-z0-9]/g, '_');
                    const rightLabel = rightMatch ? rightMatch[2] : right;
                    
                    if (arrow === '->') {
                        mermaidStr += `    ${leftId}["${leftLabel}"] --> ${rightId}["${rightLabel}"]\n`;
                    } else if (arrow === '<-') {
                        mermaidStr += `    ${rightId}["${rightLabel}"] --> ${leftId}["${leftLabel}"]\n`;
                    }
                }
            });
            return mermaidStr;
        }

        async function updateReport(key) {
            const data = examples[key];
            if (!data) return;

            // Update text content
            document.getElementById('factual-story').innerText = data.T;
            document.getElementById('intervention-variable').innerText = data.V;
            document.getElementById('cf-question').innerText = data.Q;
            document.getElementById('math-query').innerText = data.M;
            document.getElementById('response-s').innerText = data.S;
            document.getElementById('response-s-prime').innerText = data["S'"];
            document.getElementById('error-description').innerText = data.Error;
            document.getElementById('raw-graph-text').innerText = data.G;

            // Render Diagram
            const mermaidDefinition = parseGraphToMermaid(data.G);
            const container = document.getElementById('mermaid-container');
            
            // Clear previous diagram
            container.innerHTML = `<pre class="mermaid" id="mermaid-viz">${mermaidDefinition}</pre>`;
            
            // Re-initialize mermaid
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'base',
                themeVariables: {
                    primaryColor: '#f5f3ff',
                    primaryTextColor: '#7c3aed',
                    primaryBorderColor: '#7c3aed',
                    lineColor: '#8b5cf6',
                    secondaryColor: '#f8fafc',
                    tertiaryColor: '#ffffff',
                    fontSize: '14px',
                    fontFamily: 'Inter'
                }
            });
            await mermaid.run({
                nodes: [document.getElementById('mermaid-viz')]
            });
        }

        // Event Listener for Selector
        document.getElementById('example-selector').addEventListener('change', (e) => {
            updateReport(e.target.value);
        });

        // Initial Load
        window.addEventListener('DOMContentLoaded', () => {
            updateReport('sports_donk_vitality');
        });
    </script>
</body>
</html>
